function state(){var n=arguments;changestate(LambdaTM.list2json(n))}function getUrlParam(n){var e=new RegExp("(^|&)"+n+"=([^&]*)(&|$)"),a=window.location.search.substr(1).match(e);return null!=a?unescape(a[2]):null}var LambdaTM={};Util={},Util.cons=function(n,e){var a=new LambdaTM.Cell;return a.car=n,a.cdr=e,a},LambdaTM.Symbol=function(n){this.name=n},LambdaTM.getSymbol=function(n){return"#t"==n?!0:"#f"==n?!1:(this.name=n,new LambdaTM.Symbol(n))},LambdaTM.EOFException=function(){},LambdaTM.SyntaxEx=function(n){this.errorMessage=n},LambdaTM.Cell=function(){this.car=null,this.cdr=null},LambdaTM.StringReader=function(n){var e=0,a=n;return function(){return a.length==e?65535:a.charAt(e++)}},LambdaTM.LambdaTMReader=function(n){function e(n){return" "==n||"\n"==n||"	"==n||"\r"==n}function a(){if(m===!1&&(m=n(),65535==m))throw new LambdaTM.EOFException;return m}function t(){var n=a();if(65535==n)throw new LambdaTM.EOFException;return m=!1,n}function r(){for(var n=a();e(n);)t(),n=a()}function o(){var n="";try{for(var e=t();'"'!=e;)"\\"==e&&(e=t(),"t"==e?n+="	":"n"==e?n+="\n":"r"==e?n+="\r":"b"==e?n+="\b":"f"==e&&(n+="\f")),n+=e,e=t()}catch(a){if(a instanceof LambdaTM.EOFException)throw new LambdaTM.SyntaxEx("Unknown read syntax reading string: ")}return n}function i(n){return n>="0"&&"9">=n?!0:!1}function c(n){var e=n.charCodeAt(0);return"!"==n||e>34&&39>e||e>41&&59>e||e>59&&96>e||e>96&&127>e||n>=128&&65535!=n?!0:!1}function l(){for(var n,r="";;)try{if(n=a(),e(n)||"("==n||")"==n||'"'==n||";"==n)return r;r+=t()}catch(o){if(o instanceof LambdaTM.EOFException)return r}}function s(n){return"#f"==n?!1:"#t"==n?!0:LambdaTM.getSymbol(n)}function d(){var n=new LambdaTM.Cell,e=n;try{for(;;){var o=u();e.car=o,r();var i=a();if(")"==i){t();break}if("."==i){if(t(),e.cdr=u(),r(),i=a(),")"!=i)throw new LambdaTM.SyntaxEx("Unknown read syntax reading improper list: ");t();break}var c=new LambdaTM.Cell;e.cdr=c,e=c}}catch(l){if(l instanceof LambdaTM.EOFException)throw new LambdaTM.SyntaxEx("Unknown read syntax reading improper list: ")}return n}function u(){for(var n=t();e(n)||";"==n;){for(;e(n);)n=t();if(";"==n)for(;"\n"!=n;)n=t()}if(65535==n)return null;if("'"==n||"`"==n){var m=u(),b=new LambdaTM.Cell,f=new LambdaTM.Cell;return b.car=LambdaTM.getSymbol("'"==n?"quote":"quasiquote"),b.cdr=f,f.car=m,f.cdr=null,b}if(","==n){var b=new LambdaTM.Cell,f=new LambdaTM.Cell;b.car=LambdaTM.getSymbol("unquote"),n=a(),"@"==n&&(t(),b.car=LambdaTM.getSymbol("unquote-splicing"));var m=u();return b.cdr=f,f.car=m,f.cdr=null,b}if("#"==n){try{a()}catch(v){if(!(v instanceof LambdaTM.EOFException))throw v}var L=l();return s(n+L)}if('"'==n)return o();if(i(n)){var p=l(),L=n+p,T=parseFloat(L);if(T==0/0)throw new LambdaTM.SyntaxEx("");return T}if("+"==n||"-"==n){var p=l();if(""==p)return LambdaTM.getSymbol(""+n);var T=parseFloat(n+p);if(T==0/0)throw new LambdaTM.SyntaxEx("");return T}if(c(n)){var p=l();return LambdaTM.getSymbol(n+p)}if("("==n)return r(),n=a(),")"==n?(t(),null):d();throw new LambdaTM.SyntaxEx("Unknown read syntax reading improper list char:"+n)}var n=n,m=!1;return u},LambdaTM.evalEx=function(n){this.errorMessage=n},LambdaTM.calljsmacro=function(lisp){if(lisp instanceof LambdaTM.Cell){if(lisp.car instanceof LambdaTM.Symbol){for(var f=eval(lisp.car.name),args=[],cell=lisp.cdr;null!=cell&&cell instanceof LambdaTM.Cell;)args.push(cell.car),cell=cell.cdr;return f.apply(window,args)}throw new LambdaTM.evalEx("eval error, not symbol function")}throw new LambdaTM.evalEx("eval error,not code")},LambdaTM.sexp2list=function(n){for(var e=[],a=n;null!=a&&a instanceof LambdaTM.Cell;)e.push(a.car),a=a.cdr;return e},LambdaTM.Error=function(n,e){return this.fatal=!0,this.car=n,this.cdr=e,this},LambdaTM.ERROR={},LambdaTM.ERROR.EnvironmentSymbol_EX=new LambdaTM.getSymbol("EnvironmentSymbol_EX"),LambdaTM.ERROR.Syntex_Ex=new LambdaTM.getSymbol("Syntex_Ex"),LambdaTM.Env=function(n){return this.car=n||null,this.cdr=null,this.make=function(n,e){return Util.cons(Util.cons(n,e),null)},this.find=function(n){if("string"==typeof n)return this.find(LambdaTM.getSymbol(n));if(n instanceof LambdaTM.Symbol){var e=null;for(e=this.cdr;null!=e;){var a=e.car;if(n.name===a.car.name)return a.cdr;e=e.cdr}return null!=this.car?this.car.find(n):new LambdaTM.Error(LambdaTM.ERROR.EnvironmentSymbol_EX,"find not symbol:"+n)}},this.set=function(n,e){if(n instanceof LambdaTM.Symbol){for(var a=this.cdr;null!=a;){var t=a.car;if(n===t.car)return t.cdr=e,e;a=a.cdr}return null!=this.car?this.car.set(n,e):new LambdaTM.Error(LambdaTM.ERROR.EnvironmentSymbol_EX,"symbol:"+n+" value:"+e)}},this.setLocal=function(n,e){if("string"==typeof n)return this.setLocal(LambdaTM.getSymbol(n),e);if(n instanceof LambdaTM.Symbol){var a=this.cdr;for(null==a&&(this.cdr=this.make(n,e));null!=a;){var t=a.car;if(n===t.car)return t.cdr=e,e;if(null==a.cdr)return a.cdr=this.make(n,e),e;a=a.cdr}}return e},this},LambdaTM.TailRecursive=function(){this.closureenv=null,this.closurecode=null},LambdaTM.LispEval={},LambdaTM.LispEval.lisp_eval=function(n,e){if(null!=e){if(e instanceof LambdaTM.Symbol)return n.find(e);if(e instanceof LambdaTM.Cell)return LambdaTM.LispEval.eval_list(n,e)}return e},LambdaTM.LispEval.eval_func_args=function(n,e){if(null==e)return null;for(var a=new LambdaTM.Cell,t=a,r=e;;){var o=LambdaTM.LispEval.lisp_eval(n,r.car);if(o instanceof LambdaTM.Error)return o;if(t.car=o,r=r.cdr,null==r)break;t.cdr=new LambdaTM.Cell,t=t.cdr}return a},LambdaTM.LispEval.defer_eval=function(n,e){if(!(e instanceof LambdaTM.Cell))return lisp_eval(n,e);var a=new LambdaTM.TailRecursive;return a.closureenv=n,a.closurecode=e,a},LambdaTM.LispEval.eval_call=function(n,e){if(null==e)return null;var a=LambdaTM.LispEval.lisp_eval(n,e.car);if(null==a)return e;var t=null;if(a instanceof LambdaTM.LambdaFunction){var r=LambdaTM.LispEval.eval_func_args(n,e.cdr);return r instanceof LambdaTM.Error?r:t=a.apply(n,r)}if(a instanceof LambdaTM.mprocedure){var r=e.cdr;t=a.apply(n,r);var o=LambdaTM.LispEval.lisp_eval(n,t);return o}if(a instanceof LambdaTM.LambdaMacro){var r=e.cdr;return t=a.apply(n,r)}return a instanceof LambdaTM.Error?a:new LambdaTM.Error("EnvironmentSymbol_EX","Invalid function call "+a)},LambdaTM.LispEval.run_function_body=function(n,e,a){for(var t=null;null!=e;e=e.cdr){if(!(e instanceof LambdaTM.Cell))return new LambdaTM.Error(LambdaTM.ERROR.Syntex_Ex," not list ");if(null==e.cdr&&a)return LambdaTM.LispEval.defer_eval(n,e.car);if(t=LambdaTM.LispEval.lisp_eval(n,e.car),t instanceof LambdaTM.Error)return t}return t},LambdaTM.LispEval.eval_list=function(n,e){for(var a=LambdaTM.LispEval.eval_call(n,e);null!=a&&a instanceof LambdaTM.TailRecursive;)n=a.closureenv,e=a.closurecode,a=LambdaTM.LispEval.eval_call(n,e);return a},LambdaTM.LambdaMacro=function(){},LambdaTM.LambdaFunction=function(){},LambdaTM.LambdaFunction.prototype=new LambdaTM.LambdaMacro,LambdaTM.mprocedure=function(){this.closurecode,this.closureenv},LambdaTM.mprocedure.prototype=new LambdaTM.LambdaFunction,Util.proxycall=function(n,e,a){return n.apply(window,LambdaTM.sexp2list(Util.cons(e,a)))},LambdaTM.globalenv=new LambdaTM.Env,onmessage=function(){return this.apply=function(env,args){if(args.cdr.car===window.tid){var tag=args.cdr.cdr.car,f=eval(tag),as=LambdaTM.sexp2list(args.cdr.cdr.cdr);return f.apply(window,as)}},this},onmessage.prototype=new LambdaTM.LambdaFunction,LambdaTM.globalenv.setLocal("onmessage",new onmessage),LambdaTM.list2json=function(n){for(var e={},a=0;a<n.length;){var t=n[a++],r=n[a++];e[t]=r}return e};var SEXP={};SEXP.parse=function(n){var e=new LambdaTM.LambdaTMReader(new LambdaTM.StringReader(n))();return LambdaTM.sexp2list(e)},SEXP.exec=function(n){var e=new LambdaTM.LambdaTMReader(new LambdaTM.StringReader(n))();return LambdaTM.LispEval.lisp_eval(LambdaTM.globalenv,e)},Array.prototype.toObj=function(){var n={};if(this.length%2==0){for(var e=0;e<this.length;e+=2)n[this[e]]=this[e+1];return n}};var Toast=function(n){this.context=n.context||$("body"),this.message=n.message,this.time=n.time||3e3,this.init()},msgEntity;Toast.prototype={init:function(){$("#toastMessage").remove();var n=new Array;n.push('<div id="toastMessage">'),n.push("<span>"+this.message+"</span>"),n.push("</div>"),msgEntity=$(n.join("")).appendTo(this.context);var e=this.context.width()/2-msgEntity.find("span").width()/2,a="20px";msgEntity.css({position:"fixed",bottom:a,"z-index":"99",left:e,"background-color":"#000000",color:"white","font-size":"14px",padding:"5px",margin:"0px","border-radius":"2px"}),msgEntity.hide()},show:function(){msgEntity.fadeIn(this.time/2),msgEntity.fadeOut(this.time/2)}},function(n,e){"function"==typeof define&&define.amd?define([],e):"undefined"!=typeof module&&module.exports?module.exports=e():n.ReconnectingWebSocket=e()}(this,function(){function n(e,a,t){function r(n,e){var a=document.createEvent("CustomEvent");return a.initCustomEvent(n,!1,!1,e),a}var o={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null};t||(t={});for(var i in o)this[i]="undefined"!=typeof t[i]?t[i]:o[i];this.url=e,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var c,l=this,s=!1,d=!1,u=document.createElement("div");u.addEventListener("open",function(n){l.onopen(n)}),u.addEventListener("close",function(n){l.onclose(n)}),u.addEventListener("connecting",function(n){l.onconnecting(n)}),u.addEventListener("message",function(n){l.onmessage(n)}),u.addEventListener("error",function(n){l.onerror(n)}),this.addEventListener=u.addEventListener.bind(u),this.removeEventListener=u.removeEventListener.bind(u),this.dispatchEvent=u.dispatchEvent.bind(u),this.open=function(e){if(c=new WebSocket(l.url,a||[]),e){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else u.dispatchEvent(r("connecting")),this.reconnectAttempts=0;(l.debug||n.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",l.url);var t=c,o=setTimeout(function(){(l.debug||n.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",l.url),d=!0,t.close(),d=!1},l.timeoutInterval);c.onopen=function(a){clearTimeout(o),(l.debug||n.debugAll)&&console.debug("ReconnectingWebSocket","onopen",l.url),l.protocol=c.protocol,l.readyState=WebSocket.OPEN,l.reconnectAttempts=0;var t=r("open");t.isReconnect=e,e=!1,u.dispatchEvent(t)},c.onclose=function(a){if(clearTimeout(o),c=null,s)l.readyState=WebSocket.CLOSED,u.dispatchEvent(r("close"));else{l.readyState=WebSocket.CONNECTING;var t=r("connecting");t.code=a.code,t.reason=a.reason,t.wasClean=a.wasClean,u.dispatchEvent(t),e||d||((l.debug||n.debugAll)&&console.debug("ReconnectingWebSocket","onclose",l.url),u.dispatchEvent(r("close")));var o=l.reconnectInterval*Math.pow(l.reconnectDecay,l.reconnectAttempts);setTimeout(function(){l.reconnectAttempts++,l.open(!0)},o>l.maxReconnectInterval?l.maxReconnectInterval:o)}},c.onmessage=function(e){(l.debug||n.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",l.url,e.data);var a=r("message");a.data=e.data,u.dispatchEvent(a)},c.onerror=function(e){(l.debug||n.debugAll)&&console.debug("ReconnectingWebSocket","onerror",l.url,e),u.dispatchEvent(r("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(e){if(c)return(l.debug||n.debugAll)&&console.debug("ReconnectingWebSocket","send",l.url,e),c.send(e);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(n,e){"undefined"==typeof n&&(n=1e3),s=!0,c&&c.close(n,e)},this.refresh=function(){c&&c.close()}}if("WebSocket"in window)return n.prototype.onopen=function(n){},n.prototype.onclose=function(n){},n.prototype.onconnecting=function(n){},n.prototype.onmessage=function(n){},n.prototype.onerror=function(n){},n.debugAll=!1,n.CONNECTING=WebSocket.CONNECTING,n.OPEN=WebSocket.OPEN,n.CLOSING=WebSocket.CLOSING,n.CLOSED=WebSocket.CLOSED,n});var tid=getUrlParam("tid"),host=getUrlParam("host")||"23.88.239.2",token=getUrlParam("access_key"),user=Math.floor(100*Math.random()),url="ws://"+host+":8080/websocket/t/"+user+"/code/"+token+"/user",ws=new ReconnectingWebSocket(url);ws.onmessage=function(n){console.debug("[WEBSOCKET] "+n.data),SEXP.exec(n.data)},ws.onerror=function(){console.error("[WEBSOCKET] connection error")},ws.onopen=function(){console.debug("[WEBSOCKET] connection opened"),ws.send('(get-state "{tid}")'.replace("{tid}",tid)),$.modal.close()},ws.onclose=function(){console.error("[WEBSOCKET] connection closed")},$(function(){var n=new Toast({message:"指令已发送"});$("#power").click(function(e){var a='(@devcall "{tid}" (controlkey {args}) (lambda (x) x))'.replace("{tid}",tid).replace("{args}","14 1 300");console.debug("[CODE] "+a),ws.send(a),n.show()}),$("#back").click(function(n){console.debug("[EVENT] back clicked"),window.close()}),$("#modal").modal({escapeClose:!1,clickClose:!1,showClose:!1})}),window.changestate=function(n){};