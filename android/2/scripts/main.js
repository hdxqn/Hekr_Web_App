function state(){var e=arguments;changestate(LambdaTM.list2json(e))}
function getUrlParam(e){var n=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),
t=window.location.search.substr(1).match(n);
return null!=t?unescape(t[2]):null}
function toggle01(e){return 0===e?1:0}
function toggle012(e){return 2===e?0:e+1}
function toggle123(e){return 3===e?1:e+1}
function buttonKeyUpCSS(e,n){$(e).removeClass(n)}
function buttonKeyDownCSS(e,n){$(e).addClass(n)}
function buttonCSS(e){buttonKeyDownCSS(e,"off"),setTimeout('buttonKeyUpCSS("'+e+'","off")',200)}
function setPowerState(e){$("#statePower").text(1===e?"OPEN":"CLOSE"),$("#statePower").flash(200),$("#statePower2").text(1===e?"开":"关"),$("#funcPower").data("power",e),$("#funcPower")[1===e?"removeClass":"addClass"]("off"),$("#funcAeration")[1===e?"on":"off"]("click",onFuncAeration),$("#funcAeration")[1===e?"removeClass":"addClass"]("off")}
function setAerationState(e){$("#stateAeration").text(1===e?"抽风":"吹风"),$("#funcAeration").data("a",e)}
function setLightState(e){$("#stateLight").text(1===e?"照明开":"照明关"),$("#funcLight").data("light",e),$("#funcLight")[1===e?"removeClass":"addClass"]("off")}
function getWWText(e){switch(e){case 0:return"风暖关";case 1:return"风暖I";case 2:return"风暖II"}}
function setWWState(e){$("#stateWW").text(getWWText(e)),$("#funcWW").data("ww",e)}
function setLWState(e){$("#stateLW").text(1===e?"灯暖开":"灯暖关"),$("#funcLW").data("lw",e),$("#funcLW")[1===e?"removeClass":"addClass"]("off")}var LambdaTM={};Util={},Util.cons=function(e,n){var t=new LambdaTM.Cell;return t.car=e,t.cdr=n,t},LambdaTM.Symbol=function(e){this.name=e},LambdaTM.getSymbol=function(e){return"#t"==e?!0:"#f"==e?!1:(this.name=e,new LambdaTM.Symbol(e))},LambdaTM.EOFException=function(){},LambdaTM.SyntaxEx=function(e){this.errorMessage=e},LambdaTM.Cell=function(){this.car=null,this.cdr=null},LambdaTM.StringReader=function(e){var n=0,t=e;return function(){return t.length==n?65535:t.charAt(n++)}},LambdaTM.LambdaTMReader=function(e){function n(e){return" "==e||"\n"==e||"	"==e||"\r"==e}function t(){if(f===!1&&(f=e(),65535==f))throw new LambdaTM.EOFException;return f}function a(){var e=t();if(65535==e)throw new LambdaTM.EOFException;return f=!1,e}function r(){for(var e=t();n(e);)a(),e=t()}function o(){var e="";try{for(var n=a();'"'!=n;)"\\"==n&&(n=a(),"t"==n?e+="	":"n"==n?e+="\n":"r"==n?e+="\r":"b"==n?e+="\b":"f"==n&&(e+="\f")),e+=n,n=a()}catch(t){if(t instanceof LambdaTM.EOFException)throw new LambdaTM.SyntaxEx("Unknown read syntax reading string: ")}return e}function c(e){return e>="0"&&"9">=e?!0:!1}function i(e){var n=e.charCodeAt(0);return"!"==e||n>34&&39>n||n>41&&59>n||n>59&&96>n||n>96&&127>n||e>=128&&65535!=e?!0:!1}function s(){for(var e,r="";;)try{if(e=t(),n(e)||"("==e||")"==e||'"'==e||";"==e)return r;r+=a()}catch(o){if(o instanceof LambdaTM.EOFException)return r}}function l(e){return"#f"==e?!1:"#t"==e?!0:LambdaTM.getSymbol(e)}function u(){var e=new LambdaTM.Cell,n=e;try{for(;;){var o=d();n.car=o,r();var c=t();if(")"==c){a();break}if("."==c){if(a(),n.cdr=d(),r(),c=t(),")"!=c)throw new LambdaTM.SyntaxEx("Unknown read syntax reading improper list: ");a();break}var i=new LambdaTM.Cell;n.cdr=i,n=i}}catch(s){if(s instanceof LambdaTM.EOFException)throw new LambdaTM.SyntaxEx("Unknown read syntax reading improper list: ")}return e}function d(){for(var e=a();n(e)||";"==e;){for(;n(e);)e=a();if(";"==e)for(;"\n"!=e;)e=a()}if(65535==e)return null;if("'"==e||"`"==e){var f=d(),m=new LambdaTM.Cell,b=new LambdaTM.Cell;return m.car=LambdaTM.getSymbol("'"==e?"quote":"quasiquote"),m.cdr=b,b.car=f,b.cdr=null,m}if(","==e){var m=new LambdaTM.Cell,b=new LambdaTM.Cell;m.car=LambdaTM.getSymbol("unquote"),e=t(),"@"==e&&(a(),m.car=LambdaTM.getSymbol("unquote-splicing"));var f=d();return m.cdr=b,b.car=f,b.cdr=null,m}if("#"==e){try{t()}catch(p){if(!(p instanceof LambdaTM.EOFException))throw p}var L=s();return l(e+L)}if('"'==e)return o();if(c(e)){var v=s(),L=e+v,g=parseFloat(L);if(g==0/0)throw new LambdaTM.SyntaxEx("");return g}if("+"==e||"-"==e){var v=s();if(""==v)return LambdaTM.getSymbol(""+e);var g=parseFloat(e+v);if(g==0/0)throw new LambdaTM.SyntaxEx("");return g}if(i(e)){var v=s();return LambdaTM.getSymbol(e+v)}if("("==e)return r(),e=t(),")"==e?(a(),null):u();throw new LambdaTM.SyntaxEx("Unknown read syntax reading improper list char:"+e)}var e=e,f=!1;return d},LambdaTM.evalEx=function(e){this.errorMessage=e},LambdaTM.calljsmacro=function(lisp){if(lisp instanceof LambdaTM.Cell){if(lisp.car instanceof LambdaTM.Symbol){for(var f=eval(lisp.car.name),args=[],cell=lisp.cdr;null!=cell&&cell instanceof LambdaTM.Cell;)args.push(cell.car),cell=cell.cdr;return f.apply(window,args)}throw new LambdaTM.evalEx("eval error, not symbol function")}throw new LambdaTM.evalEx("eval error,not code")},LambdaTM.sexp2list=function(e){for(var n=[],t=e;null!=t&&t instanceof LambdaTM.Cell;)n.push(t.car),t=t.cdr;return n},LambdaTM.Error=function(e,n){return this.fatal=!0,this.car=e,this.cdr=n,this},LambdaTM.ERROR={},LambdaTM.ERROR.EnvironmentSymbol_EX=new LambdaTM.getSymbol("EnvironmentSymbol_EX"),LambdaTM.ERROR.Syntex_Ex=new LambdaTM.getSymbol("Syntex_Ex"),LambdaTM.Env=function(e){return this.car=e||null,this.cdr=null,this.make=function(e,n){return Util.cons(Util.cons(e,n),null)},this.find=function(e){if("string"==typeof e)return this.find(LambdaTM.getSymbol(e));if(e instanceof LambdaTM.Symbol){var n=null;for(n=this.cdr;null!=n;){var t=n.car;if(e.name===t.car.name)return t.cdr;n=n.cdr}return null!=this.car?this.car.find(e):new LambdaTM.Error(LambdaTM.ERROR.EnvironmentSymbol_EX,"find not symbol:"+e)}},this.set=function(e,n){if(e instanceof LambdaTM.Symbol){for(var t=this.cdr;null!=t;){var a=t.car;if(e===a.car)return a.cdr=n,n;t=t.cdr}return null!=this.car?this.car.set(e,n):new LambdaTM.Error(LambdaTM.ERROR.EnvironmentSymbol_EX,"symbol:"+e+" value:"+n)}},this.setLocal=function(e,n){if("string"==typeof e)return this.setLocal(LambdaTM.getSymbol(e),n);if(e instanceof LambdaTM.Symbol){var t=this.cdr;for(null==t&&(this.cdr=this.make(e,n));null!=t;){var a=t.car;if(e===a.car)return a.cdr=n,n;if(null==t.cdr)return t.cdr=this.make(e,n),n;t=t.cdr}}return n},this},LambdaTM.TailRecursive=function(){this.closureenv=null,this.closurecode=null},LambdaTM.LispEval={},LambdaTM.LispEval.lisp_eval=function(e,n){if(null!=n){if(n instanceof LambdaTM.Symbol)return e.find(n);if(n instanceof LambdaTM.Cell)return LambdaTM.LispEval.eval_list(e,n)}return n},LambdaTM.LispEval.eval_func_args=function(e,n){if(null==n)return null;for(var t=new LambdaTM.Cell,a=t,r=n;;){var o=LambdaTM.LispEval.lisp_eval(e,r.car);if(o instanceof LambdaTM.Error)return o;if(a.car=o,r=r.cdr,null==r)break;a.cdr=new LambdaTM.Cell,a=a.cdr}return t},LambdaTM.LispEval.defer_eval=function(e,n){if(!(n instanceof LambdaTM.Cell))return lisp_eval(e,n);var t=new LambdaTM.TailRecursive;return t.closureenv=e,t.closurecode=n,t},LambdaTM.LispEval.eval_call=function(e,n){if(null==n)return null;var t=LambdaTM.LispEval.lisp_eval(e,n.car);if(null==t)return n;var a=null;if(t instanceof LambdaTM.LambdaFunction){var r=LambdaTM.LispEval.eval_func_args(e,n.cdr);return r instanceof LambdaTM.Error?r:a=t.apply(e,r)}if(t instanceof LambdaTM.mprocedure){var r=n.cdr;a=t.apply(e,r);var o=LambdaTM.LispEval.lisp_eval(e,a);return o}if(t instanceof LambdaTM.LambdaMacro){var r=n.cdr;return a=t.apply(e,r)}return t instanceof LambdaTM.Error?t:new LambdaTM.Error("EnvironmentSymbol_EX","Invalid function call "+t)},LambdaTM.LispEval.run_function_body=function(e,n,t){for(var a=null;null!=n;n=n.cdr){if(!(n instanceof LambdaTM.Cell))return new LambdaTM.Error(LambdaTM.ERROR.Syntex_Ex," not list ");if(null==n.cdr&&t)return LambdaTM.LispEval.defer_eval(e,n.car);if(a=LambdaTM.LispEval.lisp_eval(e,n.car),a instanceof LambdaTM.Error)return a}return a},LambdaTM.LispEval.eval_list=function(e,n){for(var t=LambdaTM.LispEval.eval_call(e,n);null!=t&&t instanceof LambdaTM.TailRecursive;)e=t.closureenv,n=t.closurecode,t=LambdaTM.LispEval.eval_call(e,n);return t},LambdaTM.LambdaMacro=function(){},LambdaTM.LambdaFunction=function(){},LambdaTM.LambdaFunction.prototype=new LambdaTM.LambdaMacro,LambdaTM.mprocedure=function(){this.closurecode,this.closureenv},LambdaTM.mprocedure.prototype=new LambdaTM.LambdaFunction,Util.proxycall=function(e,n,t){return e.apply(window,LambdaTM.sexp2list(Util.cons(n,t)))},LambdaTM.globalenv=new LambdaTM.Env,
onmessage=function(){return this.apply=function(env,args){if(args.cdr.car===window.tid){var tag=args.cdr.cdr.car,f=eval(tag),as=LambdaTM.sexp2list(args.cdr.cdr.cdr);return f.apply(window,as)}},this},onmessage.prototype=new LambdaTM.LambdaFunction,LambdaTM.globalenv.setLocal("onmessage",new onmessage),LambdaTM.list2json=function(e){for(var n={},t=0;t<e.length;){var a=e[t++],r=e[t++];n[a]=r}return n};var SEXP={};SEXP.parse=function(e){var n=new LambdaTM.LambdaTMReader(new LambdaTM.StringReader(e))();return LambdaTM.sexp2list(n)},SEXP.exec=function(e){var n=new LambdaTM.LambdaTMReader(new LambdaTM.StringReader(e))();return LambdaTM.LispEval.lisp_eval(LambdaTM.globalenv,n)},Array.prototype.toObj=function(){var e={};if(this.length%2==0){for(var n=0;n<this.length;n+=2)e[this[n]]=this[n+1];return e}},function(e,n){"function"==typeof define&&define.amd?define([],n):"undefined"!=typeof module&&module.exports?module.exports=n():e.ReconnectingWebSocket=n()}(this,function(){function e(n,t,a){function r(e,n){var t=document.createEvent("CustomEvent");return t.initCustomEvent(e,!1,!1,n),t}var o={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null};a||(a={});for(var c in o)this[c]="undefined"!=typeof a[c]?a[c]:o[c];this.url=n,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var i,s=this,l=!1,u=!1,d=document.createElement("div");d.addEventListener("open",function(e){s.onopen(e)}),d.addEventListener("close",function(e){s.onclose(e)}),d.addEventListener("connecting",function(e){s.onconnecting(e)}),d.addEventListener("message",function(e){s.onmessage(e)}),d.addEventListener("error",function(e){s.onerror(e)}),this.addEventListener=d.addEventListener.bind(d),this.removeEventListener=d.removeEventListener.bind(d),this.dispatchEvent=d.dispatchEvent.bind(d),this.open=function(n){if(i=new WebSocket(s.url,t||[]),n){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts)return}else d.dispatchEvent(r("connecting")),this.reconnectAttempts=0;(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",s.url);var a=i,o=setTimeout(function(){(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",s.url),u=!0,a.close(),u=!1},s.timeoutInterval);i.onopen=function(t){clearTimeout(o),(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onopen",s.url),s.protocol=i.protocol,s.readyState=WebSocket.OPEN,s.reconnectAttempts=0;var a=r("open");a.isReconnect=n,n=!1,d.dispatchEvent(a)},i.onclose=function(t){if(clearTimeout(o),i=null,l)s.readyState=WebSocket.CLOSED,d.dispatchEvent(r("close"));else{s.readyState=WebSocket.CONNECTING;var a=r("connecting");a.code=t.code,a.reason=t.reason,a.wasClean=t.wasClean,d.dispatchEvent(a),n||u||((s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onclose",s.url),d.dispatchEvent(r("close")));var o=s.reconnectInterval*Math.pow(s.reconnectDecay,s.reconnectAttempts);setTimeout(function(){s.reconnectAttempts++,s.open(!0)},o>s.maxReconnectInterval?s.maxReconnectInterval:o)}},i.onmessage=function(n){(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",s.url,n.data);var t=r("message");t.data=n.data,d.dispatchEvent(t)},i.onerror=function(n){(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","onerror",s.url,n),d.dispatchEvent(r("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(n){if(i)return(s.debug||e.debugAll)&&console.debug("ReconnectingWebSocket","send",s.url,n),i.send(n);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(e,n){"undefined"==typeof e&&(e=1e3),l=!0,i&&i.close(e,n)},this.refresh=function(){i&&i.close()}}if("WebSocket"in window)return 
	e.prototype.onopen=function(e){},
	e.prototype.onclose=function(e){},
	e.prototype.onconnecting=function(e){},
	e.prototype.onmessage=function(e){},
	e.prototype.onerror=function(e){},
	e.debugAll=!1,e.CONNECTING=WebSocket.CONNECTING,e.OPEN=WebSocket.OPEN,e.CLOSING=WebSocket.CLOSING,e.CLOSED=WebSocket.CLOSED,e});var Toast=function(e){this.context=e.context||$("body"),this.message=e.message,this.time=e.time||3e3,this.init()},msgEntity;Toast.prototype={init:function(){$("#toastMessage").remove();var e=new Array;e.push('<div id="toastMessage">'),e.push("<span>"+this.message+"</span>"),e.push("</div>"),msgEntity=$(e.join("")).appendTo(this.context);var n=this.context.width()/2-msgEntity.find("span").width()/2,t="20px";msgEntity.css({position:"fixed",bottom:t,"z-index":"99",left:n,"background-color":"#000000",color:"white","font-size":"14px",padding:"5px",margin:"0px","border-radius":"2px"}),msgEntity.hide()},show:function(){msgEntity.fadeIn(this.time/2),msgEntity.fadeOut(this.time/2)}};var tid=getUrlParam("tid"),host=getUrlParam("host")||"device.hekr.me",token=getUrlParam("access_key"),user=Math.floor(100*Math.random()),url="ws://"+host+":8080/websocket/t/"+user+"/code/"+token+"/user",ws=new ReconnectingWebSocket(url);ws.onmessage=function(e){console.debug("[RESULT] "+e.data),SEXP.exec(e.data)},ws.onerror=function(){console.error("[ERROR]")},
ws.onopen=function(){console.debug("[CONNECTED]");
setTimeout(function(){
ws.send('(get-state "{tid}")'.replace("{tid}",tid));
},500);

$.modal.close();},ws.onclose=function(){console.error("[CLOSED]")},$(function(){var e=new Toast({message:"指令已发送"}),n='(@devcall "{tid}" ({func} {args}) (lambda (x) x))'.replace("{tid}",tid);$("#back").click(function(e){console.debug("[EVENT] back button clicked"),window.close()}),$("#funcPower").click(function(t){var a=n.replace("{func}","controlpower").replace("{args}",toggle01($(this).data("power")));console.debug("[CODE] "+a),ws.send(a),e.show()}),window.onFuncAeration=function(t){var a;a=0===$("#funcAeration").data("a")?n.replace("{func}","controlaeration").replace("{args}",1):n.replace("{func}","controlblow").replace("{args}",1),console.debug("[CODE] "+a),ws.send(a),e.show(),$("#funcAeration").flash(100)},$("#funcLight").click(function(t){var a=n.replace("{func}","controllight2").replace("{args}",toggle01($(this).data("light")));console.debug("[CODE] "+a),ws.send(a),e.show()}),$("#funcWW").click(function(t){var a,r=$("#funcWW").data("ww");switch(r){case 0:a=n.replace("{func}","controlwarm1").replace("{args}",1);break;case 1:a=n.replace("{func}","controlwarm2").replace("{args}",1);break;case 2:var o=n.replace("{func}","controlwarm1").replace("{args}",0),c=n.replace("{func}","controlwarm2").replace("{args}",0);a=o+c}console.debug("[CODE] "+a),ws.send(a),e.show()}),$("#funcLW").click(function(t){var a=n.replace("{func}","controllight1").replace("{args}",toggle01($(this).data("lw")));console.debug("[CODE] "+a),ws.send(a),e.show()}),$("#modal").modal({escapeClose:!1,clickClose:!1,showClose:!1})}),$.fn.flash=function(e,n){e=e||1e3,n=n||1;for(var t=Math.floor(e/n),a=0;n>a;a++)this.fadeOut(t).fadeIn(t);return this},window.changestate=function(e){console.debug("[STATE] ================"),console.debug(e),console.debug("[STATE] ================"),setPowerState(e.power),setAerationState(e.aeration),setLightState(e.light2),setWWState(e.warm1+e.warm2),setLWState(e.light1)};