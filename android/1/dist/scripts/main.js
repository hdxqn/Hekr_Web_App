function state(){var a=arguments;changestate(LambdaTM.list2json(a))}function getUrlParam(a){var r=new RegExp("(^|&)"+a+"=([^&]*)(&|$)"),n=window.location.search.substr(1).match(r);return null!=n?unescape(n[2]):null}var LambdaTM={};Util={},Util.cons=function(a,r){var n=new LambdaTM.Cell;return n.car=a,n.cdr=r,n},LambdaTM.Symbol=function(a){this.name=a},LambdaTM.getSymbol=function(a){return"#t"==a?!0:"#f"==a?!1:(this.name=a,new LambdaTM.Symbol(a))},LambdaTM.EOFException=function(){},LambdaTM.SyntaxEx=function(a){this.errorMessage=a},LambdaTM.Cell=function(){this.car=null,this.cdr=null},LambdaTM.StringReader=function(a){var r=0,n=a;return function(){return n.length==r?65535:n.charAt(r++)}},LambdaTM.LambdaTMReader=function(a){function r(a){return" "==a||"\n"==a||"	"==a||"\r"==a}function n(){if(m===!1&&(m=a(),65535==m))throw new LambdaTM.EOFException;return m}function e(){var a=n();if(65535==a)throw new LambdaTM.EOFException;return m=!1,a}function t(){for(var a=n();r(a);)e(),a=n()}function o(){var a="";try{for(var r=e();'"'!=r;)"\\"==r&&(r=e(),"t"==r?a+="	":"n"==r?a+="\n":"r"==r?a+="\r":"b"==r?a+="\b":"f"==r&&(a+="\f")),a+=r,r=e()}catch(n){if(n instanceof LambdaTM.EOFException)throw new LambdaTM.SyntaxEx("Unknown read syntax reading string: ")}return a}function i(a){return a>="0"&&"9">=a?!0:!1}function l(a){var r=a.charCodeAt(0);return"!"==a||r>34&&39>r||r>41&&59>r||r>59&&96>r||r>96&&127>r||a>=128&&65535!=a?!0:!1}function c(){for(var a,t="";;)try{if(a=n(),r(a)||"("==a||")"==a||'"'==a||";"==a)return t;t+=e()}catch(o){if(o instanceof LambdaTM.EOFException)return t}}function s(a){return"#f"==a?!1:"#t"==a?!0:LambdaTM.getSymbol(a)}function d(){var a=new LambdaTM.Cell,r=a;try{for(;;){var o=u();r.car=o,t();var i=n();if(")"==i){e();break}if("."==i){if(e(),r.cdr=u(),t(),i=n(),")"!=i)throw new LambdaTM.SyntaxEx("Unknown read syntax reading improper list: ");e();break}var l=new LambdaTM.Cell;r.cdr=l,r=l}}catch(c){if(c instanceof LambdaTM.EOFException)throw new LambdaTM.SyntaxEx("Unknown read syntax reading improper list: ")}return a}function u(){for(var a=e();r(a)||";"==a;){for(;r(a);)a=e();if(";"==a)for(;"\n"!=a;)a=e()}if(65535==a)return null;if("'"==a||"`"==a){var m=u(),f=new LambdaTM.Cell,b=new LambdaTM.Cell;return f.car=LambdaTM.getSymbol("'"==a?"quote":"quasiquote"),f.cdr=b,b.car=m,b.cdr=null,f}if(","==a){var f=new LambdaTM.Cell,b=new LambdaTM.Cell;f.car=LambdaTM.getSymbol("unquote"),a=n(),"@"==a&&(e(),f.car=LambdaTM.getSymbol("unquote-splicing"));var m=u();return f.cdr=b,b.car=m,b.cdr=null,f}if("#"==a){try{n()}catch(L){if(!(L instanceof LambdaTM.EOFException))throw L}var v=c();return s(a+v)}if('"'==a)return o();if(i(a)){var p=c(),v=a+p,M=parseFloat(v);if(M==0/0)throw new LambdaTM.SyntaxEx("");return M}if("+"==a||"-"==a){var p=c();if(""==p)return LambdaTM.getSymbol(""+a);var M=parseFloat(a+p);if(M==0/0)throw new LambdaTM.SyntaxEx("");return M}if(l(a)){var p=c();return LambdaTM.getSymbol(a+p)}if("("==a)return t(),a=n(),")"==a?(e(),null):d();throw new LambdaTM.SyntaxEx("Unknown read syntax reading improper list char:"+a)}var a=a,m=!1;return u},LambdaTM.evalEx=function(a){this.errorMessage=a},LambdaTM.calljsmacro=function(lisp){if(lisp instanceof LambdaTM.Cell){if(lisp.car instanceof LambdaTM.Symbol){for(var f=eval(lisp.car.name),args=[],cell=lisp.cdr;null!=cell&&cell instanceof LambdaTM.Cell;)args.push(cell.car),cell=cell.cdr;return f.apply(window,args)}throw new LambdaTM.evalEx("eval error, not symbol function")}throw new LambdaTM.evalEx("eval error,not code")},LambdaTM.sexp2list=function(a){for(var r=[],n=a;null!=n&&n instanceof LambdaTM.Cell;)r.push(n.car),n=n.cdr;return r},LambdaTM.Error=function(a,r){return this.fatal=!0,this.car=a,this.cdr=r,this},LambdaTM.ERROR={},LambdaTM.ERROR.EnvironmentSymbol_EX=new LambdaTM.getSymbol("EnvironmentSymbol_EX"),LambdaTM.ERROR.Syntex_Ex=new LambdaTM.getSymbol("Syntex_Ex"),LambdaTM.Env=function(a){return this.car=a||null,this.cdr=null,this.make=function(a,r){return Util.cons(Util.cons(a,r),null)},this.find=function(a){if("string"==typeof a)return this.find(LambdaTM.getSymbol(a));if(a instanceof LambdaTM.Symbol){var r=null;for(r=this.cdr;null!=r;){var n=r.car;if(a.name===n.car.name)return n.cdr;r=r.cdr}return null!=this.car?this.car.find(a):new LambdaTM.Error(LambdaTM.ERROR.EnvironmentSymbol_EX,"find not symbol:"+a)}},this.set=function(a,r){if(a instanceof LambdaTM.Symbol){for(var n=this.cdr;null!=n;){var e=n.car;if(a===e.car)return e.cdr=r,r;n=n.cdr}return null!=this.car?this.car.set(a,r):new LambdaTM.Error(LambdaTM.ERROR.EnvironmentSymbol_EX,"symbol:"+a+" value:"+r)}},this.setLocal=function(a,r){if("string"==typeof a)return this.setLocal(LambdaTM.getSymbol(a),r);if(a instanceof LambdaTM.Symbol){var n=this.cdr;for(null==n&&(this.cdr=this.make(a,r));null!=n;){var e=n.car;if(a===e.car)return e.cdr=r,r;if(null==n.cdr)return n.cdr=this.make(a,r),r;n=n.cdr}}return r},this},LambdaTM.TailRecursive=function(){this.closureenv=null,this.closurecode=null},LambdaTM.LispEval={},LambdaTM.LispEval.lisp_eval=function(a,r){if(null!=r){if(r instanceof LambdaTM.Symbol)return a.find(r);if(r instanceof LambdaTM.Cell)return LambdaTM.LispEval.eval_list(a,r)}return r},LambdaTM.LispEval.eval_func_args=function(a,r){if(null==r)return null;for(var n=new LambdaTM.Cell,e=n,t=r;;){var o=LambdaTM.LispEval.lisp_eval(a,t.car);if(o instanceof LambdaTM.Error)return o;if(e.car=o,t=t.cdr,null==t)break;e.cdr=new LambdaTM.Cell,e=e.cdr}return n},LambdaTM.LispEval.defer_eval=function(a,r){if(!(r instanceof LambdaTM.Cell))return lisp_eval(a,r);var n=new LambdaTM.TailRecursive;return n.closureenv=a,n.closurecode=r,n},LambdaTM.LispEval.eval_call=function(a,r){if(null==r)return null;var n=LambdaTM.LispEval.lisp_eval(a,r.car);if(null==n)return r;var e=null;if(n instanceof LambdaTM.LambdaFunction){var t=LambdaTM.LispEval.eval_func_args(a,r.cdr);return t instanceof LambdaTM.Error?t:e=n.apply(a,t)}if(n instanceof LambdaTM.mprocedure){var t=r.cdr;e=n.apply(a,t);var o=LambdaTM.LispEval.lisp_eval(a,e);return o}if(n instanceof LambdaTM.LambdaMacro){var t=r.cdr;return e=n.apply(a,t)}return n instanceof LambdaTM.Error?n:new LambdaTM.Error("EnvironmentSymbol_EX","Invalid function call "+n)},LambdaTM.LispEval.run_function_body=function(a,r,n){for(var e=null;null!=r;r=r.cdr){if(!(r instanceof LambdaTM.Cell))return new LambdaTM.Error(LambdaTM.ERROR.Syntex_Ex," not list ");if(null==r.cdr&&n)return LambdaTM.LispEval.defer_eval(a,r.car);if(e=LambdaTM.LispEval.lisp_eval(a,r.car),e instanceof LambdaTM.Error)return e}return e},LambdaTM.LispEval.eval_list=function(a,r){for(var n=LambdaTM.LispEval.eval_call(a,r);null!=n&&n instanceof LambdaTM.TailRecursive;)a=n.closureenv,r=n.closurecode,n=LambdaTM.LispEval.eval_call(a,r);return n},LambdaTM.LambdaMacro=function(){},LambdaTM.LambdaFunction=function(){},LambdaTM.LambdaFunction.prototype=new LambdaTM.LambdaMacro,LambdaTM.mprocedure=function(){this.closurecode,this.closureenv},LambdaTM.mprocedure.prototype=new LambdaTM.LambdaFunction,Util.proxycall=function(a,r,n){return a.apply(window,LambdaTM.sexp2list(Util.cons(r,n)))},LambdaTM.globalenv=new LambdaTM.Env,onmessage=function(){return this.apply=function(env,args){if(args.cdr.car===window.tid){var tag=args.cdr.cdr.car,f=eval(tag),as=LambdaTM.sexp2list(args.cdr.cdr.cdr);return f.apply(window,as)}},this},onmessage.prototype=new LambdaTM.LambdaFunction,LambdaTM.globalenv.setLocal("onmessage",new onmessage),LambdaTM.list2json=function(a){for(var r={},n=0;n<a.length;){var e=a[n++],t=a[n++];r[e]=t}return r};var SEXP={};SEXP.parse=function(a){var r=new LambdaTM.LambdaTMReader(new LambdaTM.StringReader(a))();return LambdaTM.sexp2list(r)},SEXP.exec=function(a){var r=new LambdaTM.LambdaTMReader(new LambdaTM.StringReader(a))();return LambdaTM.LispEval.lisp_eval(LambdaTM.globalenv,r)},Array.prototype.toObj=function(){var a={};if(this.length%2==0){for(var r=0;r<this.length;r+=2)a[this[r]]=this[r+1];return a}},function(){var a=window;if(a.WebSocket)return void console.debug("Native supported!");var r=a.WebSocket=function(a){if(this.socket=WebSocketFactory.getInstance(a),!this.socket)throw new Error("Websocket instantiation failed! Address might be wrong.");r.store[this.socket.getId()]=this};r._keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",r._decode=function(a){var r,n,e,t,o,i,l,c="",s=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");s<a.length;)t=this._keyStr.indexOf(a.charAt(s++)),o=this._keyStr.indexOf(a.charAt(s++)),i=this._keyStr.indexOf(a.charAt(s++)),l=this._keyStr.indexOf(a.charAt(s++)),r=t<<2|o>>4,n=(15&o)<<4|i>>2,e=(3&i)<<6|l,c+=String.fromCharCode(r),64!=i&&(c+=String.fromCharCode(n)),64!=l&&(c+=String.fromCharCode(e));return c=this._utf8_decode(c)},r._utf8_decode=function(a){for(var r="",n=0,e=c1=c2=0;n<a.length;)e=a.charCodeAt(n),128>e?(r+=String.fromCharCode(e),n++):e>191&&224>e?(c2=a.charCodeAt(n+1),r+=String.fromCharCode((31&e)<<6|63&c2),n+=2):(c2=a.charCodeAt(n+1),c3=a.charCodeAt(n+2),r+=String.fromCharCode((15&e)<<12|(63&c2)<<6|63&c3),n+=3);return r},r.store={},r.onmessage=function(n){r.store[n._target].onmessage.call(a,this._decode(n._data))},r.onopen=function(n){r.store[n._target].onopen.call(a,n)},r.onclose=function(n){r.store[n._target].onclose.call(a,n)},r.onerror=function(n){r.store[n._target].onerror.call(a,n)},r.prototype.send=function(a){this.socket.send(a)},r.prototype.close=function(){this.socket.close()},r.prototype.getReadyState=function(){this.socket.getReadyState()},r.prototype.onopen=function(){throw new Error("onopen not implemented.")},r.prototype.onmessage=function(a){throw new Error("onmessage not implemented.")},r.prototype.onerror=function(a){throw new Error("onerror not implemented.")},r.prototype.onclose=function(){throw new Error("onclose not implemented.")}}();var tid=getUrlParam("tid"),host=getUrlParam("host"),token=getUrlParam("access_key"),user=Math.floor(100*Math.random()),url="ws://"+host+":8080/websocket/t/"+user+"/code/"+token+"/user",ws=new WebSocket(url);ws.onmessage=function(a){console.log(a.data),SEXP.exec(a.data)},ws.onerror=function(){console.log("error")},ws.onopen=function(){console.log("open")},ws.onclose=function(){console.log("close")},$(function(){$("#power").click(function(a){var r='(@devcall "{tid}" (controlpower {args}) (lambda (x) x))'.replace("{tid}",tid),n="";isPowerOn()?(n=r.replace("{args}",0),powerOff()):(n=r.replace("{args}",1),powerOn()),console.log("CODE: "+n),ws.send(n)}),$("#timer").change(function(a){var r=a.target.value;console.debug("slider value is "+r);var n=3600*r+" "+(isPowerOn()?0:1);console.log("args: "+n);var e='(@devcall "{tid}" (controltimer {args}) (lambda (x) x))'.replace("{tid}",tid).replace("{args}",n);console.log(r),console.log(e),timerChange(r),ws.send(e)})});var isPowerOn=function(){return!$("#power").hasClass("off")},powerOn=function(){$("#power").removeClass("off"),$("#powerState").text("开"),$("#timerState1").text("关闭"),$("#timerState2").text("关闭")},powerOff=function(){$("#power").addClass("off"),$("#powerState").text("关"),$("#timerState1").text("开启"),$("#timerState2").text("开启")},timerChange=function(a){$("#timer").val(a),$("#time1").text(a),$("#time2").text(a)};window.changestate=function(a){void 0!==a.power&&(0==a.power?powerOff():powerOn()),void 0!==a.timer&&timerChange(Math.floor(a.timer/3600))};